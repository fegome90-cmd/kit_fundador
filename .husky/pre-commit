#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running CodeRabbitAI Prevention Pre-Commit Validation..."

# Phase 1: Type Safety & Async (25% weight)
echo "ğŸ”´ Checking Type Safety & Async..."
npx tsc --noEmit --strict
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript compilation failed"
  echo "ğŸ’¡ Fix: Review async/await patterns and method return types"
  exit 1
fi
echo "âœ… TypeScript compilation passed"

# Phase 2: Dependency Management (20% weight)
echo "ğŸŸ¡ Checking Dependency Management..."
npm install --dry-run
if [ $? -ne 0 ]; then
  echo "âŒ Dependency installation failed"
  echo "ğŸ’¡ Fix: Check @types/ compatibility and remove deprecated stubs"
  exit 1
fi

npm audit --audit-level=moderate
if [ $? -ne 0 ]; then
  echo "âŒ Security audit failed"
  echo "ğŸ’¡ Fix: Update dependencies to resolve security vulnerabilities"
  exit 1
fi
echo "âœ… Dependencies validated"

# Phase 3: Testing Standards (25% weight)
echo "ğŸ”µ Checking Testing Standards..."
npm test -- --passWithNoTests
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed"
  echo "ğŸ’¡ Fix: Review test isolation, server management, and assertions"
  exit 1
fi
echo "âœ… Tests passed"

# Phase 4: Documentation Integrity (30% weight)
echo "ğŸŸ¢ Checking Documentation Integrity..."
npx markdownlint .
if [ $? -ne 0 ]; then
  echo "âŒ Markdown linting failed"
  echo "ğŸ’¡ Fix: Use markdownlint --fix and review MD040, MD036 violations"
  exit 1
fi
echo "âœ… Documentation validated"

echo "ğŸ¯ All validations passed - Ready for commit"
echo "ğŸ“Š Expected Impact: 85% reduction in CodeRabbitAI issues (18 â†’ <3)"