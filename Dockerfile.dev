FROM node:20-alpine AS base

WORKDIR /app

RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    curl

FROM base AS dependencies

COPY package*.json ./

RUN npm ci

FROM base AS development

COPY --from=dependencies /app/node_modules ./node_modules

COPY . .

EXPOSE 3000 9229

CMD ["npm", "run", "dev"]

FROM development AS testing

ENV NODE_ENV=test

CMD ["npm", "test"]
